INFO:     Started server process [21469]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8080 (Press CTRL+C to quit)
INFO:     127.0.0.1:52024 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:52026 - "WebSocket /ws" [accepted]
INFO:     connection open
知识库绝对路径: /Users/caoyibo/Desktop/mediAi/data/knowledge_base.json

==================================================
开始加载知识库...
正在读取知识库文件: /Users/caoyibo/Desktop/mediAi/data/knowledge_base.json
文件大小: 23170 字节

知识库加载统计:
- reimbursement_policies: 6 条
- materials_requirements: 6 条
- contacts: 3 条
- hospitals: 3 条
- common_questions: 6 条
- special_cases: 4 条
- procedures: 2 条

知识库加载成功! 共 30 条知识项
==================================================

🏥 医疗报销智能助手 - 通义千问流式版启动
==================================================
📱 主页: http://localhost:8080
🌐 Web界面: http://localhost:8080/web
📚 API文档: http://localhost:8080/docs
🔍 健康检查: http://localhost:8080/health
==================================================
💡 按 Ctrl+C 停止服务

INFO:     127.0.0.1:52046 - "GET /health HTTP/1.1" 200 OK
INFO:     127.0.0.1:52176 - "GET /web HTTP/1.1" 200 OK
INFO:     127.0.0.1:52677 - "GET /web HTTP/1.1" 200 OK
INFO:     connection closed
INFO:     connection closed
INFO:     127.0.0.1:52705 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:52707 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     connection closed
INFO:     connection closed
INFO:     127.0.0.1:55213 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:55215 - "WebSocket /ws" [accepted]
INFO:     connection open
WebSocket连接已断开
WebSocket连接已断开

--------------------------------------------------
收到用户查询: '住院需要什么材料？'
提取关键词: ['住院需要什么材料']
检测到特殊关键词: ['住院', '材料']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
  - 标题关键词匹配: 住院 in 学生住院比例 (+5)
  - 内容关键词匹配: 住院 in policy_stu_inpatient (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
搜索分类: materials_requirements (6条)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标题关键词匹配: 住院 in 住院资料-南海医院 (+5)
  - 内容关键词匹配: 住院 in material_inpatient_nanhai (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标题关键词匹配: 住院 in 住院资料-合同/专科医院 (+5)
  - 内容关键词匹配: 住院 in material_inpatient_contract (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 内容关键词匹配: 住院 in material_holiday_er (+3)
  - 标签关键词匹配: 材料 in 材料 (+4)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 住院 in 住院 (+4)
搜索分类: common_questions (6条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - FAQ问题关键词匹配: 住院 (+6)
搜索分类: special_cases (4条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 场景关键词匹配: 住院 (+4)
搜索分类: procedures (2条)

找到 12 条匹配结果

排名前 {min(limit, len(results))} 条结果:
结果 1: [materials_requirements] 住院资料-南海医院 (分数: 16)
   内容: 南海医院住院报销所需资料。
结果 2: [materials_requirements] 住院资料-合同/专科医院 (分数: 16)
   内容: 威海合同/专科医院住院报销所需资料。
结果 3: [reimbursement_policies] 学生住院比例 (分数: 12)
   内容: 学生住院在公疗范围内个人承担5%，即报销95%；康复住院费须在术后3个月内报销有效。
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 410

--------------------------------------------------
收到用户查询: '报销找哪个老师？'
提取关键词: ['报销找哪个老师']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
搜索分类: materials_requirements (6条)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
搜索分类: common_questions (6条)
搜索分类: special_cases (4条)
搜索分类: procedures (2条)

找到 0 条匹配结果
未找到匹配结果
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 254

--------------------------------------------------
收到用户查询: '威海市中心医院地址在哪？'
提取关键词: ['威海市中心医院地址在哪']
检测到特殊关键词: ['威海市中心医院', '办公地点']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
  - 内容关键词匹配: 威海市中心医院 in policy_stu_dental (+3)
搜索分类: materials_requirements (6条)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
  - 人名匹配: 威海市中心医院 (+15)
  - 医院名称匹配: 威海市中心医院 (+10)
搜索分类: common_questions (6条)
搜索分类: special_cases (4条)
搜索分类: procedures (2条)

找到 2 条匹配结果

排名前 {min(limit, len(results))} 条结果:
结果 1: [hospitals] None (分数: 25)
   内容: 
结果 2: [reimbursement_policies] 学生口腔门诊比例-南海/中心医院 (分数: 3)
   内容: 学生口腔疾病在南海新区医院与威海市中心医院门诊，个人负担15%，即报销85%。
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 219

--------------------------------------------------
收到用户查询: '感冒药能报销吗？'
提取关键词: ['感冒药能报销吗']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
搜索分类: materials_requirements (6条)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
搜索分类: common_questions (6条)
搜索分类: special_cases (4条)
搜索分类: procedures (2条)

找到 0 条匹配结果
未找到匹配结果
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 254

--------------------------------------------------
收到用户查询: '住院需要什么材料？'
提取关键词: ['住院需要什么材料']
检测到特殊关键词: ['住院', '材料']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
  - 标题关键词匹配: 住院 in 学生住院比例 (+5)
  - 内容关键词匹配: 住院 in policy_stu_inpatient (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
搜索分类: materials_requirements (6条)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标题关键词匹配: 住院 in 住院资料-南海医院 (+5)
  - 内容关键词匹配: 住院 in material_inpatient_nanhai (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标题关键词匹配: 住院 in 住院资料-合同/专科医院 (+5)
  - 内容关键词匹配: 住院 in material_inpatient_contract (+3)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 标签关键词匹配: 材料 in 材料 (+4)
  - 内容关键词匹配: 住院 in material_holiday_er (+3)
  - 标签关键词匹配: 材料 in 材料 (+4)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 标签关键词匹配: 住院 in 住院 (+4)
搜索分类: common_questions (6条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - FAQ问题关键词匹配: 住院 (+6)
搜索分类: special_cases (4条)
  - 标签关键词匹配: 住院 in 住院 (+4)
  - 场景关键词匹配: 住院 (+4)
搜索分类: procedures (2条)

找到 12 条匹配结果

排名前 {min(limit, len(results))} 条结果:
结果 1: [materials_requirements] 住院资料-南海医院 (分数: 16)
   内容: 南海医院住院报销所需资料。
结果 2: [materials_requirements] 住院资料-合同/专科医院 (分数: 16)
   内容: 威海合同/专科医院住院报销所需资料。
结果 3: [reimbursement_policies] 学生住院比例 (分数: 12)
   内容: 学生住院在公疗范围内个人承担5%，即报销95%；康复住院费须在术后3个月内报销有效。
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 410
WebSocket连接已断开
WebSocket连接已断开
INFO:     127.0.0.1:55842 - "GET /web HTTP/1.1" 200 OK
INFO:     connection closed
INFO:     connection closed
INFO:     127.0.0.1:55847 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:55855 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     connection closed
INFO:     connection closed
INFO:     127.0.0.1:56456 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:56460 - "WebSocket /ws" [accepted]
INFO:     connection open
WebSocket连接已断开
WebSocket连接已断开

--------------------------------------------------
收到用户查询: '感冒药能报销吗？'
提取关键词: ['感冒药能报销吗']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
搜索分类: materials_requirements (6条)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
搜索分类: common_questions (6条)
搜索分类: special_cases (4条)
搜索分类: procedures (2条)

找到 0 条匹配结果
未找到匹配结果
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 254

--------------------------------------------------
收到用户查询: '报销找哪个老师？'
提取关键词: ['报销找哪个老师']

开始搜索知识库...
搜索分类: reimbursement_policies (6条)
搜索分类: materials_requirements (6条)
搜索分类: contacts (3条)
搜索分类: hospitals (3条)
搜索分类: common_questions (6条)
搜索分类: special_cases (4条)
搜索分类: procedures (2条)

找到 0 条匹配结果
未找到匹配结果
--------------------------------------------------

开始流式RAG生成回答，上下文长度: 254
WebSocket连接已断开
WebSocket连接已断开
INFO:     127.0.0.1:51262 - "GET /web HTTP/1.1" 200 OK
INFO:     connection closed
INFO:     connection closed
INFO:     127.0.0.1:51294 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     127.0.0.1:51296 - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:     Shutting down
INFO:     connection closed
INFO:     connection closed
INFO:     Waiting for application shutdown.
INFO:     Application shutdown complete.
INFO:     Finished server process [21469]
