# 🚀 新架构部署指南

## 📋 部署概览

新架构系统采用**意图路由+多域Agent**设计，支持水平扩展和插件化开发。

### 🏗️ 架构特点
- **单入口对话**: `/ask` 统一对话界面
- **智能路由**: 自动识别用户意图，分发到专业Agent
- **多域处理**: Process、Contact、Course、Policy专业Agent
- **分片知识库**: YAML结构化存储，智能检索
- **流式响应**: 实时显示处理过程

## 🔧 部署步骤

### 1. 环境准备

```bash
# 安装依赖
pip install -r requirements.txt

# 配置环境变量
export DASHSCOPE_API_KEY=your_api_key_here
export PORT=8081
```

### 2. 启动新架构应用

```bash
# 启动新架构应用
python qwen_router_app.py
```

### 3. 验证部署

```bash
# 健康检查
curl http://localhost:8081/health

# 访问统计
curl http://localhost:8081/stats

# 测试WebSocket
curl -N -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Sec-WebSocket-Key: test" -H "Sec-WebSocket-Version: 13" http://localhost:8081/ws
```

## 🌐 访问地址

- **统一对话界面**: http://localhost:8081/ask
- **API文档**: http://localhost:8081/docs
- **健康检查**: http://localhost:8081/health
- **访问统计**: http://localhost:8081/stats

## 📊 系统监控

### 健康检查响应
```json
{
  "status": "healthy",
  "version": "2.0.0",
  "architecture": "intent_router_multi_skills",
  "qwen_api": {
    "status": "healthy",
    "model": "qwen-plus"
  },
  "skills": {
    "process": {
      "name": "办事流程助手",
      "status": "active",
      "total_items": 8
    },
    "contact": {
      "name": "联系人助手", 
      "status": "active",
      "total_items": 8
    }
  },
  "total_skills": 2
}
```

### 访问统计响应
```json
{
  "total_visits": 100,
  "unique_visitors": 50,
  "most_used_skill": "process",
  "skill_usage": {
    "process": 60,
    "contact": 40
  },
  "intent_accuracy": {
    "process": 0.95,
    "contact": 0.98
  }
}
```

## 🔄 从旧版本迁移

### 1. 备份旧版本
```bash
# 备份旧应用
cp qwen_stream_app.py qwen_stream_app_backup.py
cp data/knowledge_base.json data/knowledge_base_backup.json
```

### 2. 数据迁移
```bash
# 知识库已自动迁移到分片结构
# data/process/reimbursement.yml
# data/contacts/teachers.yml
# data/policy/reimbursement.md
```

### 3. 切换应用
```bash
# 停止旧应用
pkill -f qwen_stream_app.py

# 启动新应用
python qwen_router_app.py
```

## 🐳 Docker部署

### Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# 安装依赖
COPY requirements.txt .
RUN pip install -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["python", "qwen_router_app.py"]
```

### 构建和运行
```bash
# 构建镜像
docker build -t campus-assistant-v2 .

# 运行容器
docker run -p 8080:8080 -e DASHSCOPE_API_KEY=your_key campus-assistant-v2
```

## ☁️ 云平台部署

### Railway部署
```json
{
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile"
  },
  "deploy": {
    "startCommand": "python qwen_router_app.py",
    "healthcheckPath": "/health"
  }
}
```

### 环境变量配置
```bash
DASHSCOPE_API_KEY=your_api_key
PORT=8080
```

## 🔧 配置优化

### 性能调优
```python
# 在qwen_router_app.py中调整
rate_limit = {
    "max_requests_per_minute": 100,  # 提高限制
    "max_requests_per_hour": 2000,   # 提高限制
}

# 知识库缓存
knowledge_cache = {
    "enabled": True,
    "ttl": 3600  # 1小时缓存
}
```

### 日志配置
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('app.log'),
        logging.StreamHandler()
    ]
)
```

## 🚨 故障排除

### 常见问题

1. **Skills加载失败**
   ```bash
   # 检查知识库文件
   ls -la data/process/
   ls -la data/contacts/
   
   # 检查YAML格式
   python -c "import yaml; yaml.safe_load(open('data/process/reimbursement.yml'))"
   ```

2. **意图路由不准确**
   ```bash
   # 测试意图识别
   python src/core/router/intent_router.py
   ```

3. **WebSocket连接失败**
   ```bash
   # 检查端口占用
   lsof -i :8081
   
   # 检查防火墙
   ufw status
   ```

### 性能监控
```bash
# 监控系统资源
htop

# 监控应用日志
tail -f app.log

# 监控访问统计
curl http://localhost:8081/stats | jq
```

## 📈 扩展开发

### 添加新Skill
1. 继承`BaseSkill`类
2. 实现`process_query`方法
3. 在`qwen_router_app.py`中注册
4. 添加对应的知识库文件

### 添加新意图
1. 在`intent_router.py`中添加模式
2. 更新`SkillType`枚举
3. 实现对应的Skill类

## 🔒 安全配置

### 访问控制
```python
# IP白名单
whitelist = {
    "127.0.0.1",
    "::1",
    "your_trusted_ip"
}

# 频率限制
rate_limit = {
    "max_requests_per_minute": 60,
    "max_requests_per_hour": 1000
}
```

### 输入验证
```python
# 恶意输入检测
dangerous_patterns = [
    '<script', 'javascript:', 'eval(', 
    'exec(', 'import os', 'subprocess'
]
```

---

**🎯 部署目标**: 确保新架构系统稳定运行，支持高并发访问

**🌟 监控重点**: 意图识别准确率、技能响应时间、用户满意度

*Built with ❤️ using 意图路由 + 多域Agent架构*
