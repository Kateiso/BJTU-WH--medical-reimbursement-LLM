# 🏗️ 技术架构文档

## 📊 架构概述

**系统名称**: 校园智能助手  
**架构版本**: v1.0  
**技术栈**: Python + FastAPI + 通义千问 + RAG  
**部署方式**: Docker + Railway  

---

## 🎯 系统架构

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面      │    │   Web API       │    │   AI服务        │
│   (Frontend)    │◄──►│   (FastAPI)     │◄──►│   (通义千问)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   WebSocket     │    │   知识库        │    │   访问控制      │
│   (实时通信)    │    │   (JSON)        │    │   (频率限制)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术栈详情

#### 后端技术
- **框架**: FastAPI 0.111.0
- **语言**: Python 3.11
- **服务器**: Uvicorn
- **AI模型**: 阿里通义千问 (Qwen-Plus)
- **知识库**: JSON文件存储
- **通信**: WebSocket + HTTP

#### 前端技术
- **界面**: HTML5 + CSS3 + JavaScript
- **渲染**: Marked.js (Markdown)
- **高亮**: Highlight.js (代码高亮)
- **通信**: WebSocket + Fetch API
- **样式**: 响应式设计

#### 部署技术
- **容器化**: Docker
- **平台**: Railway
- **域名**: www.bjtuai.cn
- **SSL**: 自动HTTPS

---

## 🔧 核心模块

### 1. 主应用模块 (qwen_stream_app.py)

#### 功能职责
- 应用初始化和配置
- 路由定义和中间件配置
- WebSocket连接管理
- 访问统计和监控

#### 关键组件
```python
# 应用配置
app = FastAPI(
    title="医疗报销智能助手",
    version="1.0.0",
    description="基于通义千问的医疗报销智能问答系统"
)

# WebSocket管理器
class ConnectionManager:
    def __init__(self):
        self.active_connections: List[WebSocket] = []
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
```

### 2. RAG引擎模块 (src/core/rag/)

#### 功能职责
- 知识库检索
- 上下文构建
- AI模型调用
- 流式响应处理

#### 核心类
```python
class QwenStreamLLM:
    def __init__(self):
        self.api_key = os.getenv("DASHSCOPE_API_KEY")
        self.model = "qwen-plus"
    
    async def rag_generate_stream(self, query: str, context: str):
        # 流式生成回答
        pass
```

### 3. 知识库模块 (src/core/knowledge/)

#### 功能职责
- 知识库加载和管理
- 知识检索和匹配
- 数据验证和更新

#### 数据结构
```json
{
  "knowledge_base": [
    {
      "category": "policy",
      "title": "学生门诊报销比例",
      "content": "具体政策内容...",
      "tags": ["门诊", "报销比例", "学生"]
    }
  ]
}
```

### 4. API模块 (src/core/api/)

#### 功能职责
- RESTful API接口
- 数据模型定义
- 请求验证和响应

#### 主要接口
- `GET /health` - 健康检查
- `GET /stats` - 访问统计
- `WebSocket /ws` - 实时问答

---

## 🔒 安全架构

### 访问控制
```python
# 频率限制配置
rate_limit = {
    "max_requests_per_minute": 60,
    "max_requests_per_hour": 1000,
    "blocked_ips": set(),
    "whitelist": {"127.0.0.1", "::1"}
}
```

### 输入验证
```python
# 恶意输入检测
dangerous_patterns = [
    '<script', 'javascript:', 'eval(', 
    'exec(', 'import os', 'subprocess'
]
```

### 环境变量管理
```python
# API密钥管理
DASHSCOPE_API_KEY = os.getenv("DASHSCOPE_API_KEY")
```

---

## 📊 数据流架构

### 用户请求处理流程
```
1. 用户输入问题
   ↓
2. WebSocket接收请求
   ↓
3. 输入验证和过滤
   ↓
4. 知识库检索
   ↓
5. 上下文构建
   ↓
6. AI模型调用
   ↓
7. 流式响应返回
   ↓
8. 前端渲染显示
```

### 知识检索流程
```
1. 用户问题分析
   ↓
2. 关键词提取
   ↓
3. 知识库匹配
   ↓
4. 相关性评分
   ↓
5. 结果排序
   ↓
6. 上下文构建
```

---

## 🚀 性能优化

### 缓存策略
- **知识库缓存**: 启动时加载到内存
- **响应缓存**: 相同问题缓存结果
- **静态资源**: CDN加速

### 并发处理
- **异步处理**: 使用async/await
- **连接池**: WebSocket连接管理
- **负载均衡**: 多实例部署

### 监控指标
- **响应时间**: < 3秒
- **并发支持**: 50+ 用户
- **可用性**: > 99%

---

## 🔄 部署架构

### 当前部署 (Railway)
```
GitHub Repository
       ↓
   Railway CI/CD
       ↓
   Docker Container
       ↓
   Production Server
       ↓
   www.bjtuai.cn
```

### 目标部署 (阿里云)
```
GitHub Repository
       ↓
   GitHub Actions
       ↓
   Docker Registry
       ↓
   ECS + RDS
       ↓
   www.bjtuai.cn (已备案)
```

---

## 📈 扩展性设计

### 水平扩展
- **无状态设计**: 支持多实例部署
- **负载均衡**: 请求分发
- **数据库分离**: 独立数据库服务

### 垂直扩展
- **模块化设计**: 功能模块独立
- **插件架构**: 支持功能扩展
- **配置驱动**: 通过配置控制功能

---

## 🛠️ 开发环境

### 本地开发
```bash
# 环境要求
Python 3.11+
Docker (可选)

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
export DASHSCOPE_API_KEY=your_key

# 启动开发服务器
python qwen_stream_app.py
```

### 测试环境
```bash
# 运行测试
pytest tests/

# 健康检查
curl http://localhost:8081/health

# 功能测试
curl http://localhost:8081/stats
```

---

## 📋 技术债务

### 当前问题
1. **数据存储**: JSON文件 → 数据库
2. **缓存系统**: 内存缓存 → Redis
3. **监控系统**: 基础统计 → 完整监控
4. **日志系统**: 简单打印 → 结构化日志

### 改进计划
1. **数据库迁移**: 迁移到MySQL
2. **缓存优化**: 添加Redis缓存
3. **监控完善**: 集成监控系统
4. **日志规范**: 结构化日志记录

---

## 📞 技术支持

**架构师**: 曹益波  
**邮箱**: C.yibo2@gmail.com  
**电话**: 19862294890  

---

*最后更新: 2025-09-11*
*版本: v1.0*
