# 🚀 部署指南

## 📋 部署概述

**项目**: 校园智能助手  
**当前部署**: Railway (海外)  
**目标部署**: 阿里云 (国内)  
**部署方式**: Docker容器化  

---

## 🎯 当前部署 (Railway)

### 部署信息
- **平台**: Railway
- **域名**: www.bjtuai.cn
- **状态**: 生产环境运行中
- **成本**: 免费

### 部署流程
```bash
# 1. 推送代码到GitHub
git add .
git commit -m "Update application"
git push origin main

# 2. Railway自动部署
# - 检测到代码推送
# - 自动构建Docker镜像
# - 部署到生产环境
# - 更新域名解析
```

### 环境变量配置
```bash
# Railway环境变量
DASHSCOPE_API_KEY=your_api_key_here
PORT=8080
```

### 监控和日志
- **访问统计**: https://www.bjtuai.cn/stats
- **健康检查**: https://www.bjtuai.cn/health
- **Railway控制台**: 查看部署状态和日志

---

## 🎯 目标部署 (阿里云)

### 部署架构
```
GitHub Repository
       ↓
   GitHub Actions
       ↓
   Docker Registry
       ↓
   ECS + RDS
       ↓
   www.bjtuai.cn (已备案)
```

### 资源规划
```
ECS配置:
- CPU: 1核
- 内存: 2GB
- 存储: 40GB系统盘
- 带宽: 1Mbps
- 系统: Ubuntu 20.04

RDS配置:
- 引擎: MySQL 8.0
- 规格: 1核1GB
- 存储: 20GB
- 备份: 自动备份
```

### 部署步骤

#### 1. 准备阿里云资源
```bash
# 注册阿里云账号
# 申请免费ECS和RDS
# 配置安全组和网络
```

#### 2. 配置GitHub Actions
```yaml
# .github/workflows/deploy.yml
name: Deploy to Alibaba Cloud
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Deploy to ECS
        run: |
          # 部署脚本
```

#### 3. 数据库迁移
```bash
# 从JSON文件迁移到MySQL
python scripts/migrate_to_mysql.py
```

#### 4. 域名和SSL配置
```bash
# 配置域名解析
# 申请SSL证书
# 配置HTTPS
```

---

## 🐳 Docker部署

### Dockerfile
```dockerfile
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# 安装Python依赖
COPY requirements.txt /app/requirements.txt
RUN pip install --no-cache-dir -r /app/requirements.txt

# 复制应用代码
COPY . /app

# 暴露端口
EXPOSE 8080

# 启动命令
CMD ["python", "qwen_stream_app.py"]
```

### 本地Docker部署
```bash
# 构建镜像
docker build -t campus-ai .

# 运行容器
docker run -d \
  --name campus-ai \
  -p 8081:8081 \
  -e DASHSCOPE_API_KEY=your_key \
  campus-ai

# 查看日志
docker logs campus-ai

# 停止容器
docker stop campus-ai
```

### Docker Compose部署
```yaml
# docker-compose.yml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "8081:8081"
    environment:
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
    volumes:
      - ./data:/app/data
    restart: unless-stopped
```

---

## 🔧 环境配置

### 开发环境
```bash
# 环境变量
export DASHSCOPE_API_KEY=your_api_key
export DEBUG=true
export LOG_LEVEL=DEBUG

# 启动开发服务器
python qwen_stream_app.py
```

### 测试环境
```bash
# 环境变量
export DASHSCOPE_API_KEY=test_api_key
export DEBUG=false
export LOG_LEVEL=INFO

# 运行测试
pytest tests/
```

### 生产环境
```bash
# 环境变量
export DASHSCOPE_API_KEY=production_api_key
export DEBUG=false
export LOG_LEVEL=WARNING
export PORT=8080

# 启动生产服务器
python qwen_stream_app.py
```

---

## 📊 监控和运维

### 健康检查
```bash
# 应用健康检查
curl http://localhost:8081/health

# 响应示例
{
  "status": "healthy",
  "version": "1.0.0",
  "timestamp": "2025-09-11T10:00:00Z"
}
```

### 访问统计
```bash
# 获取访问统计
curl http://localhost:8081/stats

# 响应示例
{
  "total_visits": 1000,
  "unique_visitors": 500,
  "today_visits": 50,
  "most_popular_endpoint": "/web"
}
```

### 日志管理
```bash
# 查看应用日志
tail -f logs/app.log

# 查看错误日志
grep "ERROR" logs/app.log

# 查看访问日志
grep "访问统计" logs/app.log
```

---

## 🔒 安全配置

### 防火墙配置
```bash
# 只开放必要端口
ufw allow 22    # SSH
ufw allow 80    # HTTP
ufw allow 443   # HTTPS
ufw enable
```

### SSL证书配置
```bash
# 使用Let's Encrypt
certbot --nginx -d www.bjtuai.cn

# 自动续期
crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 访问控制
```python
# 频率限制配置
RATE_LIMIT = {
    "max_requests_per_minute": 60,
    "max_requests_per_hour": 1000,
    "blocked_ips": set(),
    "whitelist": {"127.0.0.1", "::1"}
}
```

---

## 📈 性能优化

### 缓存配置
```python
# Redis缓存配置
REDIS_CONFIG = {
    "host": "localhost",
    "port": 6379,
    "db": 0,
    "password": None
}
```

### 数据库优化
```sql
-- 创建索引
CREATE INDEX idx_knowledge_category ON knowledge_base(category);
CREATE INDEX idx_knowledge_tags ON knowledge_base(tags);

-- 查询优化
EXPLAIN SELECT * FROM knowledge_base WHERE category = 'policy';
```

### CDN配置
```bash
# 阿里云CDN配置
# 静态资源缓存
# 图片、CSS、JS文件缓存
# 全球节点加速
```

---

## 🚨 故障排除

### 常见问题

#### 1. 应用无法启动
```bash
# 检查端口占用
netstat -tlnp | grep 8081

# 检查环境变量
echo $DASHSCOPE_API_KEY

# 检查依赖
pip list | grep fastapi
```

#### 2. WebSocket连接失败
```bash
# 检查防火墙
ufw status

# 检查代理设置
curl -I http://localhost:8081/ws

# 检查浏览器控制台
# 查看WebSocket连接错误
```

#### 3. AI服务调用失败
```bash
# 检查API密钥
python -c "import os; print(os.getenv('DASHSCOPE_API_KEY'))"

# 测试API连接
curl -H "Authorization: Bearer $DASHSCOPE_API_KEY" \
     https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation
```

### 日志分析
```bash
# 错误日志分析
grep "ERROR" logs/app.log | tail -20

# 性能分析
grep "响应时间" logs/app.log | awk '{print $NF}' | sort -n

# 访问分析
grep "访问统计" logs/app.log | tail -10
```

---

## 📋 部署检查清单

### 部署前检查
- [ ] 代码已提交到GitHub
- [ ] 环境变量已配置
- [ ] 依赖已安装
- [ ] 测试已通过

### 部署后检查
- [ ] 应用正常启动
- [ ] 健康检查通过
- [ ] WebSocket连接正常
- [ ] AI服务调用正常
- [ ] 访问统计正常

### 监控检查
- [ ] 日志正常记录
- [ ] 错误监控正常
- [ ] 性能监控正常
- [ ] 安全监控正常

---

## 📞 技术支持

**运维负责人**: 曹益波  
**邮箱**: C.yibo2@gmail.com  
**电话**: 19862294890  

**紧急联系**: 24小时技术支持

---

*最后更新: 2025-09-11*
*版本: v1.0*
